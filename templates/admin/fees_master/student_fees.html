{% extends 'index.html' %}
{% load static %}
{% block head %}
<style>
   .breakdowncard{
    box-shadow: 0 0 5px #c7c7c7;
    border-radius: 15px;
    padding: 10px;
    font-weight: 600;
   }
   .breakdownname{
    text-transform: capitalize;

   }
   .breakdowndates{
    display: flex;
    justify-content: space-between;

   }
   .breakdownamount{
    display: flex;
    justify-content: end;

   }
      
      
      
      
   .table-bordered thead th, .table-bordered thead td {
        border-bottom-width: 2px;
        font-weight: 700;
    }
    .table-bordered th, .table-bordered td {
        border: 1px solid #e9ecef;
    }
    .Checkbox  {
      cursor: pointer;
    }

    


    
    .label--checkbox {
      position: relative;
      margin: 0.5rem;
      font-family: Arial, sans-serif;
      line-height: 135%;
      cursor: pointer;
    }
    
    .Checkbox {
      position: relative;
      top: -0.375rem;
      margin: 0 1rem 0 0;
      cursor: pointer;
    }
    .Checkbox:before {
      -webkit-transition: all 0.1s ease-in-out;
      -moz-transition: all 0.1s ease-in-out;
      transition: all 0.1s ease-in-out;
      content: "";
      position: absolute;
      left: 0;
      z-index: 1;
      width: 1rem;
      height: 1rem;
      border: 2px solid #d2d2d2;
    }
    .Checkbox:checked:before {
      -webkit-transform: rotate(-45deg);
      -moz-transform: rotate(-45deg);
      -ms-transform: rotate(-45deg);
      -o-transform: rotate(-45deg);
      transform: rotate(-45deg);
      height: 0.5rem;
      /* width: ; */
      border-color: #00960e;
      border-top-style: none;
      border-right-style: none;
    }
    .Checkbox:after {
      content: "";
      position: absolute;
      top: -0.125rem;
      left: 0;
      width: 1.1rem;
      height: 1.1rem;
      background: #fff;
      cursor: pointer;
    }
    


    

    
    @-webkit-keyframes slideUp {
      0% {
        -webkit-transform: translateY(6.25rem);
        transform: translateY(6.25rem);
      }
      100% {
        -webkit-transform: translateY(0);
        transform: translateY(0);
      }
    }
    @keyframes slideUp {
      0% {
        -webkit-transform: translateY(6.25rem);
        transform: translateY(6.25rem);
      }
      100% {
        -webkit-transform: translateY(0);
        transform: translateY(0);
      }
    }
      
      
      
      
      
      
      
      
      
</style>
{% endblock %}

{% block heading %}
  <span class="tab-title"> <span class="px-1">Student Fees </span></span>
{% endblock %}

{% block body %}


<div class="row">

  {% for j in fees %}
  <div class="col-lg-4">
    <div class="breakdowncard my-2">
      <div class="breakdownname">
        <span>Class:{{j.fees.class_id}}</span>
      </div>
      <div class="">
        <div class="breakdowndates pt-2">
          <span class="breakdownstartdate">Academic Year :</span>
          <span class="breakdownenddate"></span>
        </div>
        <div class="breakdowndates pt-2">

          <span>{{j.fees.academic_year_id}}</span>

        </div>
      </div>
      <div class="breakdownamount pt-2">Amount : {{j.fees.total_amount}}</div>
      <div class="d-flex justify-content-between pt-2">
        <span class="btn btn-success">Pay Now</span>
        <span class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#breakdownsmodel{{forloop.counter}}">Installment</span>
      </div>
    </div>
  </div>




  <div id="breakdownsmodel{{forloop.counter}}" class="modal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-body">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title fw-semibold mb-4">Breakdowns</h5>
            <div class="card">
              <div class="card-body">
                <div class="row">
                  {% for i in j.breakdowns %}
           
                  <div class="col-lg-6">
                    <div class="breakdowncard my-2">
                      <div class="breakdownname d-flex justify-content-between">
                        <span>Name:{{i.name}}</span>
                        <span><input type="checkbox" class="Checkbox" name="" id=""></span>
                      </div>
                      <div class="py-3">
                        <div class="breakdowndates">
                          <span class="breakdownstartdate">Start Date</span>
                          <span class="breakdownenddate">End Date</span>
                        </div>
                        <div class="breakdowndates">
                          <span class="breakdownstartdate">       {{i.startdate_dd_mm_yyyy}}
                           </span>
                          <span class="breakdownenddate"> {{i.enddate_dd_mm_yyyy}}</span>
                        </div>
                      </div>
                      <div class="breakdownamount">Amount : {{i.amount}}</div>

                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="d-flex justify-content-center mt-2">
                  <span class="btn btn-success">Pay Now</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>



  {% endfor %}
</div>






{% endblock %}

{% block script %}
<script>

  var breakdowns = []; // Array to store breakdowns
  var rowno = 1; // timetable number counter
  var itemtobechange=''




  function check_existing_entry(){

    var classid=$('#class_name').val();
    var day=$('#day').val();
    var starttime=$('#start_time').val();
    var endtime=$('#end_time').val();
    var dates = getdates($('#spandatechange').html());
    var status =false
      var fd = new FormData();   
      fd.append("startdate",dates.start_date);
      fd.append("enddate",dates.end_date);
      fd.append("starttime",starttime);
      fd.append("endtime",endtime);
      fd.append("classid",classid);
      fd.append("day",day);
      fd.append("csrfmiddlewaretoken","{{csrf_token}}");

      $.ajax({
        type: "POST",
        url: frontend_url+"time_table_master/check_existing_timetable_entry",
        data: fd,
        processData: false,
        contentType: false,
        
        success: function(response) {
          console.log("timetable",response)
          if(response.response.n == 1){
            Swal.fire({
              text: response.response.msg,
              icon: 'error',
            })
            status= true
            
          }else{

            status=false
          }
  
    
        },
      });
      return status






  }










  function save_fees_distribution(){


    var isChecked = $('#breakdown').prop('checked'); // Get the checked property
    var academic_year = $('#academic_year').val();
    var class_name = $('#class_name').val();
    var total_amount = $('#total_amount').val();
    


    if(IsValid(academic_year)){
        $('#academic_year').html();
        $('#academic_year_error').show().delay(3000).slideUp();
        $('#academic_year_error').html('Please select academic year');
        $('#academic_year').focus();
        return false;
    }
    if(class_name=="" || class_name == null || class_name ==[] || class_name == undefined){
        $('#class_name').html();
        $('#class_name_error').show().delay(3000).slideUp();
        $('#class_name_error').html('Please select classes');
        $('#class_name').focus();
        return false;
    }
    if(IsValid(total_amount)){
        $('#total_amount').html();
        $('#total_amount_error').show().delay(3000).slideUp();
        $('#total_amount_error').html('Please enter total amount');
        $('#total_amount').focus();
        return false;
    }
    var breakdown_total_amount=0
    $.each(breakdowns,function(i,o){
      breakdown_total_amount+=parseInt(o.amount)
    });
    console.log('isChecked && breakdowns.length',isChecked, breakdowns.length,breakdown_total_amount,total_amount)
    if (isChecked && breakdowns.length == 0){
      Swal.fire({
        text: "Please add fees breakdowns",
        icon: 'error',
      })
      return false;

    }
    if(isChecked && breakdown_total_amount != total_amount){
      Swal.fire({
        text: "Fees total amount and  sum of breakdowns is not same.",
        icon: 'error',
      })
      return false;

    }else{
      var fd = new FormData();    
      fd.append("academic_year_id",academic_year);
      fd.append("total_amount",total_amount);
      fd.append("classes",JSON.stringify(class_name));
      fd.append("breakdown_list",JSON.stringify(breakdowns));
      fd.append("csrfmiddlewaretoken","{{csrf_token}}");

      $.ajax({
        type: "POST",
        url: frontend_url+"fees/add_fees_distrubution",
        data: fd,
        processData: false,
        contentType: false,
        
        success: function(response) {
          console.log(response)
          if(response.response.n == 1){
            Swal.fire({
              text: response.response.msg,
              icon: 'success',
            }).then((result) => {
              window.location.href = "/fees/fees_distrubution";
            });
          }else{
            Swal.fire({
              text: response.response.msg,
              icon: 'error',
            })
          }
  
    
        },
      });

    }

  };


$(document).ready(function() {












  $('#breakdown').change(function() {


      var isChecked = $(this).prop('checked'); // Get the checked property
      console.log("Checkbox checked: " + isChecked);

      // You can perform further actions based on whether the checkbox is checked
      if (isChecked) {
          $('#breakdown_div').removeClass('d-none')
          // Actions when the checkbox is checked
      } else {
          $('#breakdown_div').addClass('d-none')

          // Actions when the checkbox is unchecked
      }



  });















});

function add_breakdown(){
    
    var breakdown_name = $('#breakdown_name').val();
    var breakdown_amount = $('#breakdown_amount').val();
    var breakdown_startdate = $('#breakdown_startdate').val();
    var breakdown_enddate = $('#breakdown_enddate').val();
    if(IsValid(breakdown_name)){
        $('#breakdown_name').html();
        $('#breakdown_name_error').show().delay(3000).slideUp();
        $('#breakdown_name_error').html('Please enter breakdown name');
        $('#breakdown_name').focus();
        return false;
    }
    if(IsValid(breakdown_amount)){
        $('#breakdown_amount').html();
        $('#breakdown_amount_error').show().delay(3000).slideUp();
        $('#breakdown_amount_error').html('Please enter breakdown amount');
        $('#breakdown_amount').focus();
        return false;
    }
    if(IsValid(breakdown_startdate)){
        $('#breakdown_startdate').html();
        $('#breakdown_startdate_error').show().delay(3000).slideUp();
        $('#breakdown_startdate_error').html('Please enter breakdown startdate');
        $('#breakdown_startdate').focus();
        return false;
    }
    if(IsValid(breakdown_enddate)){
        $('#breakdown_enddate').html();
        $('#breakdown_enddate_error').show().delay(3000).slideUp();
        $('#breakdown_enddate_error').html('Please enter breakdown enddate');
        $('#breakdown_enddate').focus();
        return false;
    }

  
    $('#added_breakdowns').append(`
            <tr class="rowitem`+rowno+`">
            <td>`+breakdown_name+`</td>
            <td>`+breakdown_amount + `</td>
            <td>`+breakdown_startdate+`</td>
            <td>`+breakdown_enddate+`</td>

            <td>
                <a onclick="get_edit_obj_details(`+rowno+`);" data-bs-toggle="tooltip" title="Edit "><i class="fa-solid fa-pen-to-square mx-1"></i></a>
                <a onclick="deleterow(`+rowno+`);"  data-bs-toggle="tooltip" title="Delete "><i class="fa-solid fa-trash-can text-danger mx-1"></i></a>
            </td>
            </tr>
    `);

    $('#breakdown_name').val(' ');
    $('#breakdown_amount').val(' ');
    $('#breakdown_startdate').val(' ');
    $('#breakdown_enddate').val(' ');
  
  
  
    breakdowns.push({"itemno":rowno,"name":breakdown_name,"amount":breakdown_amount,"start_date":breakdown_startdate,"end_date":breakdown_enddate});
    rowno++;
    console.log("add draft",breakdowns)
                
          
};
function update_draft(){

    itemNo=itemtobechange
    var breakdown_name = $('#breakdown_name').val();
    var breakdown_amount = $('#breakdown_amount').val();
    var breakdown_startdate = $('#breakdown_startdate').val();
    var breakdown_enddate = $('#breakdown_enddate').val();
    if(IsValid(breakdown_name)){
        $('#breakdown_name').html();
        $('#breakdown_name_error').show().delay(3000).slideUp();
        $('#breakdown_name_error').html('Please enter breakdown name');
        $('#breakdown_name').focus();
        return false;
    }
    if(IsValid(breakdown_amount)){
        $('#breakdown_amount').html();
        $('#breakdown_amount_error').show().delay(3000).slideUp();
        $('#breakdown_amount_error').html('Please enter breakdown amount');
        $('#breakdown_amount').focus();
        return false;
    }
    if(IsValid(breakdown_startdate)){
        $('#breakdown_startdate').html();
        $('#breakdown_startdate_error').show().delay(3000).slideUp();
        $('#breakdown_startdate_error').html('Please enter breakdown startdate');
        $('#breakdown_startdate').focus();
        return false;
    }
    if(IsValid(breakdown_enddate)){
        $('#breakdown_enddate').html();
        $('#breakdown_enddate_error').show().delay(3000).slideUp();
        $('#breakdown_enddate_error').html('Please enter breakdown enddate');
        $('#breakdown_enddate').focus();
        return false;
    }

    $('.rowitem'+itemNo).html(`
        
        <td>`+breakdown_name+`</td>
        <td>`+breakdown_amount + `</td>
        <td>`+breakdown_startdate+`</td>
        <td>`+breakdown_enddate+`</td>

        <td>
            <a onclick="get_edit_obj_details(`+itemNo+`);" data-bs-toggle="tooltip" title="Edit "><i class="fa-solid fa-pen-to-square mx-1"></i></a>
            <a onclick="deleterow(`+itemNo+`);"  data-bs-toggle="tooltip" title="Delete "><i class="fa-solid fa-trash-can text-danger mx-1"></i></a>
        </td>
    
    `)







    var result=breakdowns.find(item => item.itemno === itemNo)


    if (result) {
        result.name =breakdown_name;
        result.amount =breakdown_amount;
        result.start_date =breakdown_startdate;
        result.end_date = breakdown_enddate;

    } 
    $('#breakdown_name').val(' ');
    $('#breakdown_amount').val(' ');
    $('#breakdown_startdate').val(' ');
    $('#breakdown_enddate').val(' ');

    $('#add_breakdown_btn').removeClass('d-none')
    $('#updatedraftbreakdownbtn').addClass('d-none')


};
function get_edit_obj_details(itemNo){

    var result=breakdowns.find(item => item.itemno === itemNo)
    const index = breakdowns.findIndex(item => item.itemno === itemNo);
    $('#add_breakdown_btn').addClass('d-none')
    $('#updatedraftbreakdownbtn').removeClass('d-none')
    itemtobechange=itemNo
    $("#breakdown_name").val(result.name);
    $('#breakdown_amount').val(result.amount);
    $('#breakdown_startdate').val(result.start_date);
    $('#breakdown_enddate').val(result.end_date);




};
function deleterow(id){

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!"
    }).then((result) => {
      if (result.isConfirmed) {





      var result=breakdowns.find(item => item.itemno === id)

      const index = breakdowns.findIndex(item => item.itemno === id);


      if (index !== -1) {
          breakdowns.splice(index, 1)[0];
      }
      var rownoToRemove = $('.rowitem'+id);

      rownoToRemove.remove();

      $('#breakdown_name').val(' ');
      $('#breakdown_amount').val(' ');
      $('#breakdown_startdate').val(' ');
      $('#breakdown_enddate').val(' ');

      $('#add_breakdown_btn').removeClass('d-none')
      $('#updatedraftbreakdownbtn').addClass('d-none')

    }

      console.log("delete draft",breakdowns)
      });
};
</script>
{% endblock %}
