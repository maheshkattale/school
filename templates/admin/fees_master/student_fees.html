{% extends 'index.html' %}
{% load static %}
{% block head %}
<style>
    .switch {
        display: inline-block;
        height: 34px;
        position: relative;
        width: 60px;
      }
      
      .switch input {
        display:none;
      }
      
      .slider {
        background-color: #ccc;
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: .4s;
      }
      
      .slider:before {
        background-color: #fff;
        bottom: 4px;
        content: "";
        height: 26px;
        left: 4px;
        position: absolute;
        transition: .4s;
        width: 26px;
      }
      
      input:checked + .slider {
        background-color: #66bb6a;
      }
      
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      
      .slider.round {
        border-radius: 34px;
      }
      
      .slider.round:before {
        border-radius: 50%;
      }
      
      
      
      
      
      
      
      
      
      
      
      
      
      
</style>
{% endblock %}

{% block heading %}
  <span class="tab-title"> <span class="px-1">Student Fees </span></span>
{% endblock %}

{% block body %}


{% endblock %}

{% block script %}
<script>

  var breakdowns = []; // Array to store breakdowns
  var rowno = 1; // timetable number counter
  var itemtobechange=''




  function check_existing_entry(){

    var classid=$('#class_name').val();
    var day=$('#day').val();
    var starttime=$('#start_time').val();
    var endtime=$('#end_time').val();
    var dates = getdates($('#spandatechange').html());
    var status =false
      var fd = new FormData();   
      fd.append("startdate",dates.start_date);
      fd.append("enddate",dates.end_date);
      fd.append("starttime",starttime);
      fd.append("endtime",endtime);
      fd.append("classid",classid);
      fd.append("day",day);
      fd.append("csrfmiddlewaretoken","{{csrf_token}}");

      $.ajax({
        type: "POST",
        url: frontend_url+"time_table_master/check_existing_timetable_entry",
        data: fd,
        processData: false,
        contentType: false,
        
        success: function(response) {
          console.log("timetable",response)
          if(response.response.n == 1){
            Swal.fire({
              text: response.response.msg,
              icon: 'error',
            })
            status= true
            
          }else{

            status=false
          }
  
    
        },
      });
      return status






  }










  function save_fees_distribution(){


    var isChecked = $('#breakdown').prop('checked'); // Get the checked property
    var academic_year = $('#academic_year').val();
    var class_name = $('#class_name').val();
    var total_amount = $('#total_amount').val();
    


    if(IsValid(academic_year)){
        $('#academic_year').html();
        $('#academic_year_error').show().delay(3000).slideUp();
        $('#academic_year_error').html('Please select academic year');
        $('#academic_year').focus();
        return false;
    }
    if(class_name=="" || class_name == null || class_name ==[] || class_name == undefined){
        $('#class_name').html();
        $('#class_name_error').show().delay(3000).slideUp();
        $('#class_name_error').html('Please select classes');
        $('#class_name').focus();
        return false;
    }
    if(IsValid(total_amount)){
        $('#total_amount').html();
        $('#total_amount_error').show().delay(3000).slideUp();
        $('#total_amount_error').html('Please enter total amount');
        $('#total_amount').focus();
        return false;
    }
    var breakdown_total_amount=0
    $.each(breakdowns,function(i,o){
      breakdown_total_amount+=parseInt(o.amount)
    });
    console.log('isChecked && breakdowns.length',isChecked, breakdowns.length,breakdown_total_amount,total_amount)
    if (isChecked && breakdowns.length == 0){
      Swal.fire({
        text: "Please add fees breakdowns",
        icon: 'error',
      })
      return false;

    }
    if(isChecked && breakdown_total_amount != total_amount){
      Swal.fire({
        text: "Fees total amount and  sum of breakdowns is not same.",
        icon: 'error',
      })
      return false;

    }else{
      var fd = new FormData();    
      fd.append("academic_year_id",academic_year);
      fd.append("total_amount",total_amount);
      fd.append("classes",JSON.stringify(class_name));
      fd.append("breakdown_list",JSON.stringify(breakdowns));
      fd.append("csrfmiddlewaretoken","{{csrf_token}}");

      $.ajax({
        type: "POST",
        url: frontend_url+"fees/add_fees_distrubution",
        data: fd,
        processData: false,
        contentType: false,
        
        success: function(response) {
          console.log(response)
          if(response.response.n == 1){
            Swal.fire({
              text: response.response.msg,
              icon: 'success',
            }).then((result) => {
              window.location.href = "/fees/fees_distrubution";
            });
          }else{
            Swal.fire({
              text: response.response.msg,
              icon: 'error',
            })
          }
  
    
        },
      });

    }

  };


$(document).ready(function() {












  $('#breakdown').change(function() {


      var isChecked = $(this).prop('checked'); // Get the checked property
      console.log("Checkbox checked: " + isChecked);

      // You can perform further actions based on whether the checkbox is checked
      if (isChecked) {
          $('#breakdown_div').removeClass('d-none')
          // Actions when the checkbox is checked
      } else {
          $('#breakdown_div').addClass('d-none')

          // Actions when the checkbox is unchecked
      }



  });















});

function add_breakdown(){
    
    var breakdown_name = $('#breakdown_name').val();
    var breakdown_amount = $('#breakdown_amount').val();
    var breakdown_startdate = $('#breakdown_startdate').val();
    var breakdown_enddate = $('#breakdown_enddate').val();
    if(IsValid(breakdown_name)){
        $('#breakdown_name').html();
        $('#breakdown_name_error').show().delay(3000).slideUp();
        $('#breakdown_name_error').html('Please enter breakdown name');
        $('#breakdown_name').focus();
        return false;
    }
    if(IsValid(breakdown_amount)){
        $('#breakdown_amount').html();
        $('#breakdown_amount_error').show().delay(3000).slideUp();
        $('#breakdown_amount_error').html('Please enter breakdown amount');
        $('#breakdown_amount').focus();
        return false;
    }
    if(IsValid(breakdown_startdate)){
        $('#breakdown_startdate').html();
        $('#breakdown_startdate_error').show().delay(3000).slideUp();
        $('#breakdown_startdate_error').html('Please enter breakdown startdate');
        $('#breakdown_startdate').focus();
        return false;
    }
    if(IsValid(breakdown_enddate)){
        $('#breakdown_enddate').html();
        $('#breakdown_enddate_error').show().delay(3000).slideUp();
        $('#breakdown_enddate_error').html('Please enter breakdown enddate');
        $('#breakdown_enddate').focus();
        return false;
    }

  
    $('#added_breakdowns').append(`
            <tr class="rowitem`+rowno+`">
            <td>`+breakdown_name+`</td>
            <td>`+breakdown_amount + `</td>
            <td>`+breakdown_startdate+`</td>
            <td>`+breakdown_enddate+`</td>

            <td>
                <a onclick="get_edit_obj_details(`+rowno+`);" data-bs-toggle="tooltip" title="Edit "><i class="fa-solid fa-pen-to-square mx-1"></i></a>
                <a onclick="deleterow(`+rowno+`);"  data-bs-toggle="tooltip" title="Delete "><i class="fa-solid fa-trash-can text-danger mx-1"></i></a>
            </td>
            </tr>
    `);

    $('#breakdown_name').val(' ');
    $('#breakdown_amount').val(' ');
    $('#breakdown_startdate').val(' ');
    $('#breakdown_enddate').val(' ');
  
  
  
    breakdowns.push({"itemno":rowno,"name":breakdown_name,"amount":breakdown_amount,"start_date":breakdown_startdate,"end_date":breakdown_enddate});
    rowno++;
    console.log("add draft",breakdowns)
                
          
};
function update_draft(){

    itemNo=itemtobechange
    var breakdown_name = $('#breakdown_name').val();
    var breakdown_amount = $('#breakdown_amount').val();
    var breakdown_startdate = $('#breakdown_startdate').val();
    var breakdown_enddate = $('#breakdown_enddate').val();
    if(IsValid(breakdown_name)){
        $('#breakdown_name').html();
        $('#breakdown_name_error').show().delay(3000).slideUp();
        $('#breakdown_name_error').html('Please enter breakdown name');
        $('#breakdown_name').focus();
        return false;
    }
    if(IsValid(breakdown_amount)){
        $('#breakdown_amount').html();
        $('#breakdown_amount_error').show().delay(3000).slideUp();
        $('#breakdown_amount_error').html('Please enter breakdown amount');
        $('#breakdown_amount').focus();
        return false;
    }
    if(IsValid(breakdown_startdate)){
        $('#breakdown_startdate').html();
        $('#breakdown_startdate_error').show().delay(3000).slideUp();
        $('#breakdown_startdate_error').html('Please enter breakdown startdate');
        $('#breakdown_startdate').focus();
        return false;
    }
    if(IsValid(breakdown_enddate)){
        $('#breakdown_enddate').html();
        $('#breakdown_enddate_error').show().delay(3000).slideUp();
        $('#breakdown_enddate_error').html('Please enter breakdown enddate');
        $('#breakdown_enddate').focus();
        return false;
    }

    $('.rowitem'+itemNo).html(`
        
        <td>`+breakdown_name+`</td>
        <td>`+breakdown_amount + `</td>
        <td>`+breakdown_startdate+`</td>
        <td>`+breakdown_enddate+`</td>

        <td>
            <a onclick="get_edit_obj_details(`+itemNo+`);" data-bs-toggle="tooltip" title="Edit "><i class="fa-solid fa-pen-to-square mx-1"></i></a>
            <a onclick="deleterow(`+itemNo+`);"  data-bs-toggle="tooltip" title="Delete "><i class="fa-solid fa-trash-can text-danger mx-1"></i></a>
        </td>
    
    `)







    var result=breakdowns.find(item => item.itemno === itemNo)


    if (result) {
        result.name =breakdown_name;
        result.amount =breakdown_amount;
        result.start_date =breakdown_startdate;
        result.end_date = breakdown_enddate;

    } 
    $('#breakdown_name').val(' ');
    $('#breakdown_amount').val(' ');
    $('#breakdown_startdate').val(' ');
    $('#breakdown_enddate').val(' ');

    $('#add_breakdown_btn').removeClass('d-none')
    $('#updatedraftbreakdownbtn').addClass('d-none')


};
function get_edit_obj_details(itemNo){

    var result=breakdowns.find(item => item.itemno === itemNo)
    const index = breakdowns.findIndex(item => item.itemno === itemNo);
    $('#add_breakdown_btn').addClass('d-none')
    $('#updatedraftbreakdownbtn').removeClass('d-none')
    itemtobechange=itemNo
    $("#breakdown_name").val(result.name);
    $('#breakdown_amount').val(result.amount);
    $('#breakdown_startdate').val(result.start_date);
    $('#breakdown_enddate').val(result.end_date);




};
function deleterow(id){

    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!"
    }).then((result) => {
      if (result.isConfirmed) {





      var result=breakdowns.find(item => item.itemno === id)

      const index = breakdowns.findIndex(item => item.itemno === id);


      if (index !== -1) {
          breakdowns.splice(index, 1)[0];
      }
      var rownoToRemove = $('.rowitem'+id);

      rownoToRemove.remove();

      $('#breakdown_name').val(' ');
      $('#breakdown_amount').val(' ');
      $('#breakdown_startdate').val(' ');
      $('#breakdown_enddate').val(' ');

      $('#add_breakdown_btn').removeClass('d-none')
      $('#updatedraftbreakdownbtn').addClass('d-none')

    }

      console.log("delete draft",breakdowns)
      });
};
</script>
{% endblock %}
